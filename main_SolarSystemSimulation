"""
Solar System Simulation
////////////////////////

By: Tomasz Andrzejewski and Victor Steinborn
Matriculation numbers:
Victor Steinborn: ***REMOVED***
Tomasz Andrzejewski: ***REMOVED***


JH Computer Modeling
*****************

Assignment:
    Project A: Solar System

*****************
Log:
    10.02.2017
-VS: Created file
-----------------
This file contains the main script that is used to simulate the Solar System, using Velocity Verlet time integration techniques.


This file contains the main program that simulates the evolution of the system consisting of an arbitrary number of particles using the velocity Verlet time integration
algorithm, as function of time in an external potential,
with given initial conditions.

To run the program, names of 4 output files must be written to the command line.
These 4 output files hold respectively data for:
trajectory
energy
apoapsides and periapsides output extremaCheck() method.
orbital period lengths periodCalculations() method

Current Assumptions:
-----------------
-The distance between two bodies will never be less than or equal to the sum of their radii. (point particle treatment)
-The orbital period is the amount of time it takes for the particle to complete an orbit about the central particle.

comments for Victor:
-----------------
-I think when we write short comments starting with # we should be more concise, e.g. Read name of output file from command line
instead of Reads the name of the output file...

Comments for Tomasz:
-----------------
-Ok, but the comments should also be more readable to the eye, in terms of formatting.
"""

# Imports
# ---------------

import sys
import math
import numpy as np
import matplotlib.pyplot as pyplot
from Particle3D import Particle3D as P3D
from Celestial import Celestial as CEL

# Global Constants
# ---------------

# Universal Gravitational Constant G (Still need to think of what units to use)
G = 1.0
# Time step size dt (Still need to think of a good value and units)
dt = 0.001
# Total time of simulation (Still need to think of a good value and units) (It is assumed that dt is a factor of tTotal)
tTotal = 2.0

# User Input and Program Execution
# ---------------

# Read name of 4 output files from command line: trajectory, energy, extrema and periods
if len(sys.argv) != 5:
    print    "Wrong number of arguments."
    print    "Usage: " + sys.argv[
        0] + " <trajectory output file>" + " <energy output file>" + " <extrema output file>" + " <periods output file>"
    quit()
else:
    trajectory_File_Name = sys.argv[1]
    outfileName2 = sys.argv[2]
    outfileName3 = sys.argv[3]
    outfileName4 = sys.argv[4]
# Open output file for writing
trajectory_File_Handel = open(trajectory_File_Name, "w")
outfile2 = open(outfileName2, "w")
outfile3 = open(outfileName3, "w")
outfile4 = open(outfileName4, "w")

# Reading Input Files and Initializing Celestial bodies
# ---------------

# Attach file handle to input file
file_handle = open("particles.txt", "r")

# Return number of lines in the input file
num_lines = len(file_handle.readlines())
# The number of lines is equal to the number of particles in the simulation. We will save this number with another name.
particleNumber = num_lines

# Initialize list that stores Celestial objects
celestialList = []

# Read the particle data for the all the particles from file and save it in celestialList
with open("particles.txt", "r") as file_handle:
    for line in file_handle:
        components = line.split()
        celestialList = celestialList + [ CEL(P3D.from_line(line), np.array([0, 0, 0]), components[8]) ]

# Initialize all the forces acting on each body
CEL.globalForceUpdate_Initialization(G)

# Change the frame of reference of our system to one who's origin coincides with the position of the centre of mass,
# by correcting for the motion of the centre of mass.
CEL.globalCOM_Correction()

# Set up data lists
# ---------------

# EValue is a list that stores the total energy of the system at various times
EValue = []

# Main simulation loop
# ---------------

# Simulation runs from t=0 to t=tTotal (Including boundaries) in time steps of dt.
for t in np.arange(0, tTotal + dt, dt):
    # Data
    # ---------------
    CEL.globalPositionPrint_XYZ(trajectory_File_Handel, t)
    EValue.append(CEL.totalEnergy(G))

    # Dynamics
    # ---------------
    CEL.globalLeapPosition(dt)
    CEL.globalForceUpdate(G)
    CEL.globalLeapVelocity(dt)

# Data presentation
# ---------------

# Plotting Total Energy

pyplot.plot( np.arange(0, tTotal +dt , dt), EValue)
pyplot.title("The total energy of the Solar System as a function of time")
pyplot.xlabel("Time (UNITS)")
pyplot.ylabel("Total energy (UNITS)")
# Plot additional line showing the theoretical value of energy
pyplot.axhline(y=EValue[0], color='r', linestyle='dashed')
# pyplot.savefig('SolarSystem_energy.png')
pyplot.show()

